## Прогресс

- Итерация 1: /ping работает, каркас запущен (venv, long polling)
- Итерация 2: логирование INFO, скрипты setup.ps1/run.ps1, README обновлён
- Итерация 3: системный промпт RU, LLM-клиент OpenAI-совместимый, команда /ask
- Итерация 4: диалог с состояниями, приветствие, квалификация, сбор контактов
- Итерация 5: улучшенная квалификация (4 вопроса), тестирование пройдено
- Итерация 6: рекомендации LLM улучшены, ошибка 'proxies' исправлена
- Итерация 7: сохранение лидов в CSV, интеграция с диалогом, тестирование пройдено
- Итерация 8: fallback при ошибках LLM, обработка возвратных пользователей, тестирование пройдено

---

## Пошаговый план (KISS)

Основа: @doc/vision.md, @doc/product_idea.md

- [x] Итерация 1 — Каркас бота
  - Создать `bot/main.py` (aiogram, long polling), `requirements.txt`, `config/.env.example`.
  - Настроить бота через BotFather, получить токен и заполнить `.env`.
  - Команда `/ping` → ответ "pong".
  - Проверка: запустить локально, получить ответ на `/ping`.

- [x] Итерация 2 — Конфигурация и логирование
  - Подключить `.env` (python-dotenv), добавить `bot/logging_conf.py` (INFO в консоль).
  - Логировать старт/остановку и команды.
  - Проверка: команда `/ping` пишет логи.

- [x] Итерация 3 — Системный промпт и LLM‑клиент
  - Добавить `bot/prompt.py` (RU системный промпт), `bot/llm_client.py` (OpenAI‑совместимый `base_url`/`api_key`/`model`).
  - Команда `/ask <вопрос>` → ответ LLM.
  - Проверка: задать вопрос и получить осмысленный ответ.

- [x] Итерация 4 — Диалог: приветствие и стадии
  - `bot/handlers.py`: состояние в памяти (`stage`, `answers`).
  - Приветствие новым пользователям, перевод в стадию `qualifying`.
  - Проверка: новое сообщение без команды — получить приветствие.

- [x] Итерация 5 — Квалификация (2–4 уточняющих вопроса)
  - Задавать последовательные вопросы (цель, сроки/бюджет по желанию, контекст).
  - Сохранять краткие ответы в `answers`.
  - Проверка: пройти вопросы до конца.

- [x] Итерация 6 — Рекомендация услуги с LLM
  - На основе `answers` сформировать краткую рекомендацию через LLM.
  - Перевод в стадию `collecting_contact`.
  - Проверка: получить рекомендацию на русском.

- [x] Итерация 7 — Сбор контакта и CSV‑лид
  - Добавить `bot/lead_store.py`: запись строки в локальный CSV.
  - Запросить одно поле контакта (телефон/Telegram/email).
  - Сохранить лид: `timestamp, chat_id, client_name, contact, intent, notes, source, status`.
  - Проверка: после ввода контакта появится строка в CSV.

- [x] Итерация 8 — Обработка ошибок и возвратные пользователи
  - Fallback при ошибке LLM: вежливое сообщение + предложение оставить контакт.
  - Если есть незавершённая сессия — продолжить с текущей стадии.
  - Проверка: сломать ключ/URL и убедиться в корректном fallback; вернуться и продолжить диалог.


